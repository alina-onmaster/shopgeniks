## Для Windows перед использованием различных npm плагинов лучше сразу установить средства разработчика

Открыть родную консоль cmd с правами администратора:
```bash
npm install --global --production windows-build-tools
```
выполнятся один раз на операционной системе где ранее не велась разработка.

<br>

## Работа с проектом
Перед началом работы с проектом **необходимо установить модули**, описанные в package.json. Это делается командой:
```
npm i
```
и занимает какое-то время, в зависимости от мощности компьютера. Скорость выполнения этой и других команд по работе с проектом очень сильно зависит от того, на каком винчестере расположен проект. **На SSD всё значительно быстрее чем на HDD**.<br>
В дальнейшем, при наличии корректно созданной установщиком папки node_modules и отсутствии изменений в файле package.json, выполнение данной команды не требуется.

<br>

*Проверить версию того или иного модуля*, например, gulp-responsive:
```
npm list gulp-responsive
```

<br>

Если имеется готовый проект и нужно **собрать версию для разработки**, необходимо запустить команду:
```
npm run dev
```
в результате успешного выполнения этой команды в проекте должна появится папка dev в которой будут содержаться все необходимые для проверки рабочего состояния хода разработки папки и файлы. Данная команда может не выполнять дополнительно оптимизации изображений и минификации html, css и js файлов.

<br>

При *добавлении в код новых изображений* необходимо запускать команду:
```
gulp responsive
```
в результате успешного выполнения этой команды в соответствующих папках появятся изображения нужных размеров.<br>
Поддерживаемые форматы написание кода для изображений:
* `-<width>`: `image-100.png`
* `-<width>x`: `image-100x.png`
* `-<width>x<height>`: `image-100x200.png`
* `-x<height>`: `image-x200.png`
* `-<width>x<height>@<scale>x`: `image-100x200@2x.png`
* `@<scale>x`: `image@2x.png`

<br>

При *добавлении в код новых SVG-иконок* необходимо запускать команду:
```
gulp sprite
```
она должна обработать и собрать все svg файлы, начинающиеся на icon-, в единый файл sprite.svg и разместить его в папке source/img<br>
Для того чтобы новый спрайт был применён в html необходимы выполнить команду:
```
gulp html
```

<br>

**Для оптимизации изображений** используется сторонний сервис с ограничение на кол-во сжимаемых файлов, в связи с чем запуск оптимизации изображений рекомендуется запускать в тот момент, когда это действительно требуется:
```
npm run tiny
```
Для выполнения оптимизации модуль использует jpg и png файлы из папки dev.<br>
В результате успешного выполнения этой команды в папке с исходниками должна появится папка img-optimized содержащая все изображения jpg и png необходимые для корректной работы проекта.<br>
Если проект получен на доработку, он может уже содержать оптимизированные изображения и в этом случае запускать эту процедуре без явной необходимости не нужно.


<br>

Для того чтобы **собрать рабочую html-версию проекта** с настроенной оптимизацией изображений и минификацией html, css и js файлов необходимо выполнить команду
```
npm run build
```
в результате успешного выполнения этой команды в проекте должна появится папка prod содержащая все рабочие файлы и папки проекта. Если перед выполнением этой команды не выполнялась оптимизация изображений и папка img-optimized не существует, то в проекте не будет jpg и png изображений.

<br>

Для того чтобы **локально проверить стиль написания проекта** необходимо выполнить:
```
npm run test
```
результат будет выведен в консоль

<br>

Для того чтобы локально проверить русскоязычную орфографию необходимо выполнить:
```
npm run yaspeller
```
результат будет выведен в консоль и будет создан файл yaspeller_report.html в корне проекта.<br>
Если в проекте есть новые слова, не знакомые словарю, то их можно добавить в раздел dictionary файла .yaspellerrc

<br>

Для сборки шаблона запускаем команду:
```
npm run buildTemplate
```
в результате успешного выполнения этой команды в проекте должна появится папка custom содержащая папку шаблона со всеми необходимыми для его работы файлами и папками.


## Наиболее часто используемые команды git:

> git init

> git add .

> git remote add gitlab git@g2.onmaster.ru:onmaster/REPO.git

если удалённый репозиторий задан ранее и его нужно заменить:
> git remote set-url gitlab git@g2.onmaster.ru:onmaster/NEWREPO.git

> git config --global user.name "Name"

> git config --global user.email "name@site.ru"

> git commit -m "Comment"

> git push gitlab master

> git pull gitlab master

> git pull git@g2.onmaster.ru:onmaster/REPO.git master

если нужно форсировать push:
> git push -f gitlab master

если нужно исключить файл из отслеживания, но оставить его на диске:
> git rm --cached index.html

если нужно переименовать последний commit:
> git commit --amend -m "Some info"

если нужно переименовать конкретный commit:
> git commit --amend -c <d9169fe> -m "Исключение index.html"

<br>

## Настройка репозитория в GitLab

!ВАЖНО: Для того чтобы работал CI необходимо добавлять проект в группу у которого есть runner, например, группа OnMaster

В левом меню GitLab `Settings -> CI/CD -> Variables` добавляем переменные:<br>
> FOLDER_WITH_HTML_BUILD

папка в которую собирается HTML-версия проекта, например `prod`

> FOLDER_WITH_TEMPLATE_BUILD

папка в которую собирается шаблон, например `custom`

> TEMPLATE_NAME

папка шаблона, например `we`


> COMMAND_TO_BUILD_PROJECT <br>

команда которая собирает проект, например `npm run buildTemplate`


> FTP_URL

адрес FTP-сервера для заливки шаблона на хостинг, например `h3.onmaster.ru`

> FTP_USER

FTP-логин у которого корневой директорией является папка в которой размещаются шаблоны

> FTP_USER_PASS

пароль для FTP-логина.

<br>

В результате, если всё настроено правильно, после отправки изменений в репозиторий запустится его сборка, этапами которой являются:
1. Подготовка окружения - Docker-контейнер с последней версией node
2. Установка в этом образе npm-модулей описанных в файле package.json
3. Запуск теста на проверку написания стилей с помощью stylelint, отчёт можно посмотреть в левом меню GitLab `CI/CD -> pipelines` выбрав соответствующий шаг
4. Запуск теста на проверку орфографии русского языка с помощью yaspeller, отчёт можно посмотреть в левом меню GitLab `CI/CD -> pipelines` выбрав соответствующий шаг, либо по соответствующий ссылке в файле readme.md
5. Непосредственно сама сборка проекта
6. Если изменения отправлены в ветку html, то будет произведена отправка html-версии проекта на GitLab pages ссылка на которую в левом меню GitLab `Settings -> pages`, либо в файле readme.md
7. Если изменения отправлены в ветку master, то будет произведена отправка шаблона по FTP на сервер.
если изменения отправлены в ветку master, но необходимо обновить HTML-версию проекта на GitLab pages, то соответствующий шаг можно запустить в ручном режиме в левом меню GitLab `CI/CD -> pipelines`.

<br>

## Оптимизация шрифтов

1\. Устанавливаем утилиту glyphhanger:
```
npm install -g glyphhanger
```

2\. Устанавливаем Python:
```
https://www.python.org/downloads/windows/
```

3\. Скачиваем утилиту fonttools:
```
git clone https://github.com/fonttools/fonttools.git
```

3\. Устанавливаем утилиту fonttools:
```
cd fonttools
python -m virtualenv fonttools-venv
pip install -e
pip install fonttools
```

4\. Устанавливаем Brotli compression format для работы с WOFF2
``` 
pip install brotli
```

Для последующего обновления:
```
python -m pip install --upgrade pip
python -m fonttools install --upgrade fonttools
```

Проверка версии:
```
glyphhanger --version
```


Пример команд оптимизации шрифтов

```
glyphhanger --whitelist=U+A,U+20-22,U+25,U+28-3A,U+3D-45,U+48,U+49,U+4C-50,U+52-56,U+58,U+59,U+5F,U+61-69,U+6B,U+6D-70,U+72-74,U+76,U+AB,U+BB,U+401,U+410-44F,U+451,U+2014 --subset=*.ttf --formats=woff2,woff --css
```
```
glyphhanger http://site.ru --spider --whitelist=U+A,U+20-22,U+25,U+28-3A,U+3D-45,U+48,U+49,U+4C-50,U+52-56,U+58,U+59,U+5F,U+61-69,U+6B,U+6D-70,U+72-74,U+76,U+AB,U+BB,U+401,U+410-44F,U+451,U+2014 --subset=*.ttf --formats=woff2,woff --css
```
```
glyphhanger http://localhost:3000/ --spider --whitelist=абвгдеёжзийклмнопрстуфхцчшщъыьэюяАБВГДЕЁЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯ01234567890-,.:?abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ --subset=*.woff --formats=woff2,woff --css
```

<br>

## Актуализация npm
```
npm -g install npm@latest
```
